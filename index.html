<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rotating Screen</title>
    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background: #000;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #fff;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .screen {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
      }

      .screen__image {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        object-position: center;
        background: #000;
      }

      .status-bar {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.15);
        overflow: hidden;
      }

      .status-bar__fill {
        width: 0%;
        height: 100%;
        background: #2ecc71;
      }
    </style>
  </head>
  <body>
    <main class="screen">
      <img
        id="rotating-image"
        class="screen__image"
        src=""
        alt="Rotating scheduled content"
      />
      <div class="status-bar">
        <div id="status-bar-fill" class="status-bar__fill"></div>
      </div>
    </main>
    <script>
      (function () {
        const DISPLAY_DURATION_MS = 30_000;
        const PROGRAM_IMAGE = "images/program.png";
        const MANIFEST_PATH = "images/manifest.json";
        const statusFillEl = document.getElementById("status-bar-fill");
        const imageEl = document.getElementById("rotating-image");

        let rotationTimer = null;
        let sequence = [];
        let index = 0;

        function animateStatusBar() {
          statusFillEl.style.transition = "none";
          statusFillEl.style.width = "0%";

          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              statusFillEl.style.transition = `width ${DISPLAY_DURATION_MS}ms linear`;
              statusFillEl.style.width = "100%";
            });
          });
        }

        function updateImage() {
          if (!sequence.length) {
            return;
          }

          imageEl.src = sequence[index % sequence.length];
          index += 1;
          animateStatusBar();
        }

        function startRotation() {
          updateImage();

          if (rotationTimer) {
            clearInterval(rotationTimer);
          }

          rotationTimer = setInterval(updateImage, DISPLAY_DURATION_MS);
        }

        function buildSequenceFromManifest(manifest) {
          const entries = Array.isArray(manifest)
            ? manifest
            : Array.isArray(manifest?.images)
            ? manifest.images
            : [];

          const sanitized = entries
            .map((entry) => String(entry))
            .map((entry) => entry.replace(/^\.?\/?images\//i, "").trim())
            .filter(
              (entry) => entry.length > 0 && entry.toLowerCase() !== "program.png"
            );

          const alternatingSequence = sanitized.flatMap((entry) => [
            `images/${entry}`,
            PROGRAM_IMAGE,
          ]);

          if (!alternatingSequence.length) {
            alternatingSequence.push(PROGRAM_IMAGE);
          }

          return alternatingSequence;
        }

        async function loadManifest() {
          try {
            const response = await fetch(MANIFEST_PATH, {
              cache: "no-store",
            });

            if (!response.ok) {
              throw new Error(`Manifest request failed with ${response.status}`);
            }

            const manifestJson = await response.json();
            sequence = buildSequenceFromManifest(manifestJson);
          } catch (error) {
            console.error("Falling back to program image only.", error);
            sequence = [PROGRAM_IMAGE];
          }

          startRotation();
        }

        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) {
            animateStatusBar();
          }
        });

        loadManifest();
      })();
    </script>
  </body>
</html>
